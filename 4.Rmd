---
output: 
  html_document: 
    keep_md: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE, engine='python')
```
#Python For Everybody
##4 - Using Databases with Python

###0) python version used
```{r}
import sys
print(sys.version)
```

###1) object oriented python intro
```{r}
movies = list()
movie1={"Director" : "James Cameron", "Title" : "Avatar", "Release Date" : "18 December 2009", "Running Time" : "162 minutes", "Rating" : "PG-13"}
movies.append(movie1)
movie2={"Director" : "David Fincher", "Title" : "The Social Network", "Release Date" : "01 October 2010", "Running Time" : "120 minutes", "Rating" : "PG-13"}
movies.append(movie2)

keys = ["Title", "Director", "Rating", "Running Time"]
print movies
for item in movies:
    print "-------------------------"
    for key in keys:
        print key + ":", item[key] # because we expect the list of dictionary to contain values for the keys
print "-------------------------"
```

###2) simple python objects example
```{r}
class PartyAnimal:
    x = 0
    def party(self):
        self.x = self.x + 1
        print "So far", self.x
an = PartyAnimal() # instance with initial x attribute equaling 0
print "type:", type(an)
print "dir:", dir(an)
an.party() # increments x attribute by 1, prints it (1)
an.party() # "" (2)
an.party() # "" (3)
```

###3) simple demonstration of object lifecycle1
```{r}
class PartyAnimal:
    x = 0
    def __init__(self): ## two underscores each side
        print "I am constructed"
    def party(self):
        self.x = self.x + 1
        print "So far", self.x
    def __del__(self): ## destructor
        print "I am destructed", self.x
an = PartyAnimal()
an.party()
an.party()
an.party()
```

###4) simple demonstration of object lifecycle2
```{r}
class PartyAnimal:
    x = 0
    name = ""
    def __init__(self,nam):
        self.name = nam
        print self.name, "constructed"
    def party(self):
        self.x = self.x + 1
        print self.name, "party count", self.x
s = PartyAnimal("Sally")
s.party()
j = PartyAnimal("Jim")
j.party()
s.party()
```

###5) inheritance simple example
```{r}
class PartyAnimal:
    x = 0
    name = ""
    def __init__(self,nam):
        self.name = nam
        print self.name, "constructed"
    def party(self):
        self.x = self.x + 1
        print self.name, "party count", self.x
class FootballFan(PartyAnimal): # inherits all of the PartyAnimal class
    points = 0
    def touchdown(self):
        self.points = self.points + 7
        self.party() # inherited method from Parent class
        print self.name, "points", self.points
s = PartyAnimal("Sally")
s.party()
j = FootballFan("Jim") # inherits or extends Parent's attributes x,name
j.party()
j.touchdown()
```

###6) email database demo example
```{r}
import sqlite3
conn = sqlite3.connect('emaildb.sqlite')
cur = conn.cursor()
cur.execute('''
DROP TABLE IF EXISTS Counts''')
cur.execute('''
CREATE TABLE Counts (email TEXT, count INTEGER)''')
fname = "mbox-short.txt"
if(len(fname)<1) : fname = "mbox-short.txt"
fh = open(fname)
for line in fh:
    if not line.startswith("From: ") : continue
    pieces = line.split()
    print "->",pieces,"<-"
    email = pieces[1]
    '''******************************************************
    ? is a placeholder -- that it is going to be something
    (email,) is a tuple (row) -- email gets substituted for ? 
    parameter substitution using ? is a safety measure
    *******************************************************'''
    cur.execute('SELECT count FROM Counts WHERE email = ?', (email, ))
    # if email matches the one in the database, increments count by 1
    try:
        count = cur.fetchone()[0]
        cur.execute('UPDATE Counts SET count=count+1 WHERE email = ?',
                    (email,))
    # if db has not seen the email yet, set the value of count as 1
    except:
        cur.execute('''INSERT INTO Counts (email, count)
                    VALUES (?,1)''',(email,))
    conn.commit()
    
# obtaining top 10 descending counts of emails
sqlstr = "SELECT email, count FROM Counts ORDER BY count DESC LIMIT 10"

for row in cur.execute(sqlstr) : # row is a tuple
    print str(row[0]), row[1] # str in case UTF-8
```

###7) counting organization SQL assignment
```{r}
## count by organization (domain name of email)
import re
import sqlite3
conn = sqlite3.connect('emaildb_assignment.sqlite')
cur = conn.cursor()
cur.execute('''
DROP TABLE IF EXISTS Counts''')
cur.execute('''
CREATE TABLE Counts (org TEXT, count INTEGER)''')
fname = "mbox.txt"
fh = open(fname)

for line in fh:
    if not line.startswith("From "): continue
    line = line.rstrip()
    #org = re.findall("@(\S+)\s*",line)[0]
    orglist = re.findall("@(\S+)\s*",line)
    if len(orglist) > 0 :
        org = orglist[0]
        cur.execute('SELECT count FROM Counts WHERE org = ?', (org, ))
    # if email matches the one in the dKatabase, increments count by 1
    try:
        count = cur.fetchone()[0]
        cur.execute('UPDATE Counts SET count=count+1 WHERE org = ?',
                    (org,))
    # if db has not seen the email yet, set the value of count as 1
    except:
        cur.execute('''INSERT INTO Counts (org, count)
                    VALUES (?,1)''',(org,))
conn.commit()

sqlstr = "SELECT org, count FROM Counts ORDER BY count DESC"

for row in cur.execute(sqlstr) : # row is a tuple
    print "->"+str(row[0])+"<-", row[1] # str in case UTF-8
```

###8) connecting XML and SQL using python demo
```{r}
import xml.etree.ElementTree as ET
import sqlite3

conn = sqlite3.connect('trackdb.sqlite')
cur = conn.cursor()

cur.execute("DROP TABLE IF EXISTS Artist")
cur.execute("DROP TABLE IF EXISTS Album")
cur.execute("DROP TABLE IF EXISTS Track")


cur.execute('''
CREATE TABLE IF NOT EXISTS Artist (
    id   INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    name TEXT UNIQUE
)''')
cur.execute('''
CREATE TABLE IF NOT EXISTS Album (
    id        INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    artist_id INTEGER,
    title     TEXT UNIQUE
)''')
cur.execute('''
CREATE TABLE IF NOT EXISTS Track (
    id        INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    album_id  INTEGER,
    title     TEXT UNIQUE,
    len       INTEGER,
    rating    INTEGER,
    count     INTEGER
)''')
fname = "Library.xml"

''' example of XML format
<key>Track ID</key><integer>369</integer>
<key>Name</key><string>Another One Bites The Dust</string>
<key>Artist</key><string>Queen</string>'''

## function that returns the child text if the dictionary contains the key
def lookup(d, key):
    found = False
    for child in d:
        if found: return child.text
        if child.tag == "key" and child.text == key :
            found = True
    return None
stuff = ET.parse(fname)
## three <dict> level deep inside (just the way how Library.xml handles)
all = stuff.findall("dict/dict/dict")
print "Dict count:", len(all)
for entry in all:
    if(lookup(entry,"Track ID") is None): continue
    name = lookup(entry, "Name")
    artist = lookup(entry, "Artist")
    album = lookup(entry, "Album")
    count = lookup(entry, "Play Count")
    rating = lookup(entry, "Rating")
    length = lookup(entry, "Total Time")
    
    # error check
    if name is None or artist is None or album is None:
        continue
    
    # INSERT if it's not there, and IGNORE if it's already there, or if error
    cur.execute("INSERT OR IGNORE INTO Artist (name) VALUES (?)",(artist,))
    # get the artist_id for the artist that was added 
    cur.execute("SELECT id FROM Artist WHERE name = ?",(artist,))
    artist_id = cur.fetchone()[0]
    
    cur.execute('''INSERT OR IGNORE INTO Album (title, artist_id) 
                VALUES(?,?)''',(album,artist_id))
    cur.execute("SELECT id FROM Album where title = ?", (album,))
    album_id = cur.fetchone()[0]
    
    cur.execute('''INSERT OR REPLACE INTO TRACK (title, album_id, len, rating, count)
                VALUES (?,?,?,?,?)''',(name,album_id,length,rating,count))
conn.commit()
```

###9) music track database assignment
```{r}
import xml.etree.ElementTree as ET
import sqlite3
conn = sqlite3.connect('trackdb_assignment.sqlite')
cur = conn.cursor()
cur.execute("DROP TABLE IF EXISTS Artist")
cur.execute("DROP TABLE IF EXISTS Genre")
cur.execute("DROP TABLE IF EXISTS Album")
cur.execute("DROP TABLE IF EXISTS Track")
cur.execute('''
CREATE TABLE Artist (
    id  INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    name    TEXT UNIQUE
);''')
cur.execute('''
CREATE TABLE Genre (
    id  INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    name    TEXT UNIQUE
);''')
cur.execute('''
CREATE TABLE Album (
    id  INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
    artist_id  INTEGER,
    title   TEXT UNIQUE
);''')
cur.execute('''
CREATE TABLE Track (
    id  INTEGER NOT NULL PRIMARY KEY 
        AUTOINCREMENT UNIQUE,
    title TEXT  UNIQUE,
    album_id  INTEGER,
    genre_id  INTEGER,
    len INTEGER, rating INTEGER, count INTEGER
);''')
fname = "Library.xml"
def lookup(d, key):
    found = False
    for child in d:
        if found: return child.text
        if child.tag == "key" and child.text == key :
            found = True
    return None
stuff = ET.parse(fname)
all = stuff.findall("dict/dict/dict")
for entry in all:
    if(lookup(entry,"Track ID") is None): continue
    genre_name = lookup(entry, "Genre")
    artist_name = lookup(entry, "Artist")
    album_title = lookup(entry, "Album")
    track_title = lookup(entry, "Name")
    track_len = lookup(entry, "Total Time")
    track_rating = lookup(entry, "Rating")
    track_count = lookup(entry, "Play Count")
    if (genre_name is None or artist_name is None or 
        album_title is None or track_title is None): continue
    cur.execute("INSERT OR IGNORE INTO Genre (name) VALUES (?)", (genre_name,))
    cur.execute("SELECT id FROM Genre WHERE name = ?", (genre_name,))
    genre_id = cur.fetchone()[0]
    
    cur.execute("INSERT OR IGNORE INTO Artist (name) VALUES (?)", (artist_name,))
    cur.execute("SELECT id FROM Artist WHERE name = ?", (artist_name,))
    artist_id = cur.fetchone()[0]
    
    cur.execute("INSERT OR IGNORE INTO Album (artist_id, title) VALUES (?,?)", 
                (artist_id, album_title))
    cur.execute("SELECT id from Album where title = ?", (album_title,))
    album_id = cur.fetchone()[0]
    cur.execute('''INSERT OR REPLACE INTO Track 
                (title, album_id, genre_id, len, rating, count)
                VALUES (?,?,?,?,?,?)''',
                (track_title, album_id, genre_id, track_len, track_rating, track_count)
    )
conn.commit()
sql_query = '''
SELECT Track.title, Artist.name, Album.title, Genre.name 
    FROM Track JOIN Genre JOIN Album JOIN Artist 
    ON Track.genre_id = Genre.ID and Track.album_id = Album.id 
        AND Album.artist_id = Artist.id
    ORDER BY Artist.name, Track.title LIMIT 3
'''
for iteration in cur.execute(sql_query):
    print str(iteration[0]), ";", str(iteration[1]), ";", str(iteration[2]), ";", str(iteration[3])
#sqlstr = "SELECT org, count FROM Counts ORDER BY count DESC"

#for row in cur.execute(sqlquery) : # row is a tuple
#    print "->"+str(row[0])+"<-", row[1] # str in case UTF-8

```